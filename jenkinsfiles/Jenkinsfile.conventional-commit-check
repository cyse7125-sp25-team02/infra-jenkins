pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Check Conventional Commits') {
            steps {
                script {
                    def validCommits = true
                    def targetBranch = env.CHANGE_TARGET ?: 'main'
                    def commitMessages = sh(
                        script: "git log --pretty=%B ${targetBranch}..HEAD",
                        returnStdout: true
                    ).trim().split('\n\n')

                    def conventionalCommitRegex = /^(feat|fix|build|chore|ci|docs|perf|refactor|revert|style|test)(\([a-z0-9-]+\))?: [a-zA-Z0-9].+/

                    for (message in commitMessages) {
                        def firstLine = message.split('\n')[0]
                        if (!firstLine.matches(conventionalCommitRegex)) {
                            echo "ERROR: Commit message does not follow Conventional Commits: '${firstLine}'"
                            echo "       ${firstLine}"
                            validCommits = false
                        }
                    }

                    if (!validCommits) {
                        error "One or more commit messages in the Pull Request do not follow Conventional Commits."
                    } else {
                        echo "All commit messages in the Pull Request follow Conventional Commits."
                    }
                }
            }
        }
    }
}
